<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="pageTitle">Atma Printed QR Generator</title>
    <!-- Google Fonts: Inter for UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- html2canvas Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kkyCKYRA8eewvcZTptUag==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Local QR Code Generation Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary-bg: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #1c1e21;
            --border-color: #d1d5db;
            --button-bg: #000000;
            --button-hover: #333333;
            --button-secondary-bg: #6c757d;
            --button-secondary-hover: #5a6268;
            --ui-font: 'Inter', sans-serif;
            --article-font: 'Inter', sans-serif;
            --cnn-red: #CC0000;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            font-family: var(--ui-font);
            background-color: var(--primary-bg);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: clamp(1rem, 3vw, 2rem);
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            width: 100%;
            max-width: 1400px;
        }

        /* Container Berita */
        .pojok-koran {
            width: 100%;
            max-width: 960px;
            aspect-ratio: 16 / 9;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            container-type: inline-size;
            font-family: var(--article-font);
            border-top: 4px solid var(--cnn-red);
            padding: clamp(1rem, 3cqi, 2.5rem);
        }
        
        .news-category {
            color: var(--cnn-red);
            font-weight: 700;
            font-size: clamp(0.7rem, 2cqi, 1rem);
            text-transform: uppercase;
            margin: 0 0 0.5rem 0;
        }

        .pojok-koran h2 {
            margin: 0;
            padding: 0;
            font-size: clamp(1.5rem, 6cqi, 3rem);
            font-weight: 900;
            text-align: left;
            line-height: 1.2;
            color: #000;
        }

        .pojok-koran .sub-header {
            font-style: normal;
            color: #606770;
            text-align: left;
            font-size: clamp(0.7rem, 2.2cqi, 1.1rem);
            margin: clamp(0.5rem, 1.5cqi, 1rem) 0 clamp(1rem, 2.5cqi, 2rem) 0;
            padding: 0;
        }
        
        .content-wrapper {
            overflow: hidden;
            line-height: 1.7;
            padding: 0;
        }

        .pojok-koran p {
            text-align: justify;
            margin: 0 0 1rem 0;
            font-size: clamp(0.8rem, 2.8cqi, 1.4rem);
        }

        .barcode {
            float: right;
            border: 1px solid var(--border-color);
            padding: 5px;
            background-color: white;
            width: 25%;
            aspect-ratio: 1 / 1;
            height: auto;
            margin-left: clamp(0.7rem, 2cqi, 1.5rem);
            margin-bottom: clamp(0.5rem, 1cqi, 0.7rem);
        }

        .barcode > * {
            width: 100% !important;
            height: 100% !important;
        }
        
        .continue-reading {
            font-style: italic;
            font-weight: bold;
            color: #000;
        }
        
        /* Panel Kontrol */
        .controls-panel {
            width: 100%;
            max-width: 400px;
            background-color: #ffffff;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .controls-panel h3 {
            margin: 0;
            text-align: center;
            font-size: 1.25rem;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 500;
            color: #606770;
            font-size: 0.9rem;
        }
        
        .hidden {
            display: none;
        }

        .lang-switcher {
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .lang-btn {
            background-color: #fff;
            border: none;
            cursor: pointer;
            padding: 10px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            font-size: 0.9rem;
        }
        .lang-btn:not(.active) { color: #606770; }
        .lang-btn.active {
            color: white;
            background-color: var(--button-bg);
        }
        .lang-btn:first-child { border-right: 1px solid var(--border-color); }
        
        #customIdInput {
            padding: 10px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            width: 100%;
            text-align: center;
        }

        .button-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Space between buttons */
            margin-top: 0.5rem;
        }

        .control-btn {
            padding: 12px;
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none; /* For the 'a' tag */
        }
        
        #downloadBtn {
            background-color: var(--button-bg);
        }

        #downloadBtn:hover:not(:disabled) {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }
        
        #downloadBtn:disabled {
            background-color: #888888;
            cursor: wait;
        }
        
        #backToAppBtn {
            background-color: var(--button-secondary-bg);
        }
        
        #backToAppBtn:hover {
             background-color: var(--button-secondary-hover);
             transform: translateY(-2px);
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tata Letak Responsif */
        @media (min-width: 1024px) {
            .main-container {
                flex-direction: row;
                align-items: flex-start;
                justify-content: center;
            }
            .pojok-koran {
                flex: 2;
            }
            .controls-panel {
                flex: 1;
                max-width: 380px;
                position: sticky;
                top: 2rem;
            }
        }
    </style>
</head>
<body>

    <div class="main-container">
        
        <div class="pojok-koran" id="captureArea">
            <p class="news-category" id="newsCategory"></p>
            <h2 id="articleTitle"></h2>
            <p class="sub-header" id="articleSubheader"></p>
            <div class="content-wrapper">
                <div id="barcodeContainer" class="barcode"></div>
                <p id="p1"></p>
                <p id="p2"></p>
                <p class="continue-reading" id="p3-cta"></p>
            </div>
        </div>

        <div class="controls-panel">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.73l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2.73l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                <span id="controlsTitleText"></span>
            </h3>

            <div class="control-group">
                <label id="langLabel"></label>
                <div class="lang-switcher">
                    <button class="lang-btn active" id="langIdBtn">Indonesia</button>
                    <button class="lang-btn" id="langEnBtn">English</button>
                </div>
            </div>
            
            <div class="control-group hidden" id="customIdContainer">
                <label for="customIdInput" id="customIdLabel"></label>
                <input type="text" id="customIdInput" value="">
            </div>

            <div class="button-wrapper">
                <button id="downloadBtn" class="control-btn">
                    <span id="downloadBtnText"></span>
                </button>
                <a href="gesture.html" id="backToAppBtn" class="control-btn">
                    <span id="backToAppBtnText"></span>
                </a>
            </div>
        </div>

    </div>

    <script>
        // --- DOM ELEMENTS ---
        const captureArea = document.getElementById('captureArea');
        const barcodeContainer = document.getElementById('barcodeContainer');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadBtnText = document.getElementById('downloadBtnText');
        const langIdBtn = document.getElementById('langIdBtn');
        const langEnBtn = document.getElementById('langEnBtn');
        const customIdContainer = document.getElementById('customIdContainer');
        const customIdInput = document.getElementById('customIdInput');
        
        // --- TRANSLATABLE ELEMENTS ---
        const pageTitle = document.getElementById('pageTitle');
        const newsCategory = document.getElementById('newsCategory');
        const articleTitle = document.getElementById('articleTitle');
        const articleSubheader = document.getElementById('articleSubheader');
        const p1 = document.getElementById('p1');
        const p2 = document.getElementById('p2');
        const p3_cta = document.getElementById('p3-cta');
        const controlsTitleText = document.getElementById('controlsTitleText');
        const langLabel = document.getElementById('langLabel');
        const customIdLabel = document.getElementById('customIdLabel');
        const backToAppBtnText = document.getElementById('backToAppBtnText');

        // --- DATA & STATE ---
        let currentLang = 'id';
        const translations = {
            id: {
                pageTitle: "Atma Printed QR Generator",
                newsCategory: "MISTERI",
                articleTitle: "Tragedi Keluarga Smith: Anak Dibunuh, Jasadnya Menghilang",
                subheader: "Edisi 18 Januari 1924",
                p1: "Malam itu, putri bungsu keluarga Smith ditemukan tewas mengenaskan. Di lokasi kejadian, satu-satunya petunjuk adalah sebuah topeng kuno berlumuran darah.",
                p2: "Misteri semakin dalam saat jasadnya dilaporkan lenyap dari kamar mayat rumah sakit keesokan harinya, tanpa jejak.",
                cta: "Apa rahasia di balik topeng itu? Pindai kode untuk membaca kisah lengkap misteri yang tak pernah terpecahkan ini.",
                controlsTitle: "Panel Kontrol",
                langLabel: "Bahasa Tampilan",
                customIdLabel: "ID Kustom untuk Barcode",
                downloadButton: "Unduh sebagai Gambar (PNG)",
                downloadingButton: "Membuat gambar...",
                backButton: "Kembali ke Aplikasi"
            },
            en: {
                pageTitle: "Atma Printed QR Generator",
                newsCategory: "MYSTERY",
                articleTitle: "The Smith Tragedy: Child Murdered, Body Vanishes",
                subheader: "Edition January 18, 1924",
                p1: "That night, the Smith family's youngest daughter was found gruesomely murdered. At the scene, the only clue was an ancient, blood-stained mask.",
                p2: "The mystery deepened when her body was reported missing from the hospital morgue the next day, without a trace.",
                cta: "What secrets does the mask hold? Scan the code to read the full story of this unsolved mystery.",
                controlsTitle: "Control Panel",
                langLabel: "Display Language",
                customIdLabel: "Custom ID for Barcode",
                downloadButton: "Download as Image (PNG)",
                downloadingButton: "Generating image...",
                backButton: "Back to App"
            }
        };

        // --- FUNCTIONS ---
        function generateQRCode(idValue) {
            // Clear previous QR code before generating a new one
            barcodeContainer.innerHTML = '';

            // CHANGE: Only generate QR code if idValue is not empty
            if (idValue && idValue.trim() !== '') {
                const targetUrl = `https://cnid.my.id/redirects.html?id=${encodeURIComponent(idValue.trim())}`;
                const size = barcodeContainer.offsetWidth;

                new QRCode(barcodeContainer, {
                    text: targetUrl,
                    width: size,
                    height: size,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        function switchLanguage(lang) {
            currentLang = lang;
            const content = translations[lang];

            // Update all text elements
            pageTitle.textContent = content.pageTitle;
            newsCategory.textContent = content.newsCategory;
            articleTitle.textContent = content.articleTitle;
            articleSubheader.textContent = content.subheader;
            p1.textContent = content.p1;
            p2.textContent = content.p2;
            p3_cta.textContent = content.cta;
            controlsTitleText.textContent = content.controlsTitle;
            langLabel.textContent = content.langLabel;
            customIdLabel.textContent = content.customIdLabel;
            downloadBtnText.textContent = content.downloadButton;
            backToAppBtnText.textContent = content.backButton;

            // Update button active state
            langIdBtn.classList.toggle('active', lang === 'id');
            langEnBtn.classList.toggle('active', lang === 'en');
        }

        async function downloadImage() {
            downloadBtn.disabled = true;
            downloadBtnText.textContent = translations[currentLang].downloadingButton;
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            downloadBtn.prepend(spinner);

            // 1. Kloning elemen untuk dirender di luar layar dengan ukuran tetap
            const clone = captureArea.cloneNode(true);
            const cloneBarcodeContainer = clone.querySelector('#barcodeContainer');
            const cloneContentWrapper = clone.querySelector('.content-wrapper');

            // 2. Atur gaya kloning untuk render di luar layar dengan rasio 16:9 yang sempurna
            const renderWidth = 1280; // Resolusi dasar yang baik
            const renderHeight = 720;  // 1280 * 9 / 16
            clone.style.position = 'absolute';
            clone.style.top = '0';
            clone.style.left = '-9999px'; // Pindahkan jauh ke luar layar
            clone.style.width = `${renderWidth}px`;
            clone.style.height = `${renderHeight}px`;
            clone.style.maxWidth = 'none'; // Hapus batasan responsif apa pun
            
            cloneContentWrapper.style.flexGrow = '1';
            cloneContentWrapper.style.overflow = 'hidden'; 

            document.body.appendChild(clone);

            try {
                // 3. Buat ulang kode QR khusus untuk dimensi kloning
                cloneBarcodeContainer.innerHTML = ''; // Hapus konten yang ada
                const idValue = (new URLSearchParams(window.location.search)).get('id') || customIdInput.value;

                if (idValue && idValue.trim() !== '') {
                    const targetUrl = `https://cnid.my.id/redirects.html?id=${encodeURIComponent(idValue.trim())}`;
                    const barcodeSize = renderWidth * 0.25;
                    new QRCode(cloneBarcodeContainer, {
                        text: targetUrl,
                        width: barcodeSize,
                        height: barcodeSize,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
                
                await new Promise(resolve => setTimeout(resolve, 50));

                // --- LOGIKA BARU UNTUK MENYESUAIKAN UKURAN FONT ---
                const paragraphs = clone.querySelectorAll('.content-wrapper p');
                let fontSize = 10; 
                const maxFontSize = 120; 
                const increment = 1; 

                while (fontSize < maxFontSize) {
                    paragraphs.forEach(p => {
                        p.style.fontSize = `${fontSize}px`;
                        p.style.lineHeight = '1.7'; 
                    });

                    if (cloneContentWrapper.scrollHeight > cloneContentWrapper.clientHeight) {
                        fontSize -= increment;
                        break;
                    }
                    fontSize += increment;
                }
                
                // PERUBAHAN: Ambil ukuran font maksimal yang pas, lalu kecilkan sedikit agar ada ruang.
                // Nilai 0.9 berarti ukuran font akan menjadi 90% dari ukuran maksimal (pengurangan 10%).
                const finalFontSize = fontSize * 0.9;

                paragraphs.forEach(p => {
                    p.style.fontSize = `${finalFontSize}px`;
                });
                // --- AKHIR LOGIKA BARU ---

                await new Promise(resolve => setTimeout(resolve, 100));

                // 4. Tangkap kloning di luar layar
                const sourceCanvas = await html2canvas(clone, {
                    scale: 2, 
                    useCORS: true,
                    backgroundColor: getComputedStyle(captureArea).backgroundColor || '#fdfaf4',
                    width: renderWidth,
                    height: renderHeight,
                    windowWidth: renderWidth,
                    windowHeight: renderHeight,
                });

                // 5. Buat canvas akhir dengan resolusi output yang diinginkan
                const targetWidth = 1920;
                const targetHeight = 1080;
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = targetWidth;
                finalCanvas.height = targetHeight;
                const ctx = finalCanvas.getContext('2d');
                
                // 6. Gambar canvas yang ditangkap ke canvas akhir
                ctx.drawImage(sourceCanvas, 0, 0, targetWidth, targetHeight);

                // 7. Picu unduhan dari canvas akhir
                const imageURL = finalCanvas.toDataURL('image/png');
                const tempLink = document.createElement('a');
                tempLink.href = imageURL;
                tempLink.download = `Atma by heri sanjaya QR (${currentLang}).png`;
                
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);

            } catch (error) {
                console.error("Gagal membuat gambar:", error);
                alert("Maaf, gagal membuat gambar. Silakan coba lagi.");
            } finally {
                // 8. Hapus kloning dari DOM
                document.body.removeChild(clone);

                // Kembalikan status tombol
                downloadBtn.disabled = false;
                downloadBtnText.textContent = translations[currentLang].downloadButton;
                if (downloadBtn.contains(spinner)) {
                    downloadBtn.removeChild(spinner);
                }
            }
        }

        // --- EVENT LISTENERS ---
        langIdBtn.addEventListener('click', () => switchLanguage('id'));
        langEnBtn.addEventListener('click', () => switchLanguage('en'));
        downloadBtn.addEventListener('click', downloadImage);

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const idFromUrl = urlParams.get('id');

            if (idFromUrl !== null && idFromUrl.trim() !== '') {
                generateQRCode(idFromUrl);
            } else {
                customIdContainer.classList.remove('hidden');
                
                customIdInput.addEventListener('input', () => {
                    generateQRCode(customIdInput.value);
                });
            }
            
            switchLanguage('id');
        });

    </script>
</body>
</html>
